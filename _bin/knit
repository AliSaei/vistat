#!/usr/bin/env Rscript

# formatR indent 2 spaces; print width 65; no progress
options(reindent.spaces = 2, KNITR_WIDTH = 65, KNITR_PROGRESS = FALSE)

library(knitr)
stopifnot('_source' %in% list.files()) # run me from the root directory
render_jekyll()

opts_chunk$set(
  pars = list(mar = c(4, 4, .1, .1), mgp = c(2, 1, 0), bg = 'white'),
  cache = TRUE
)
knit_hooks$set(pars = function(before, options, envir) {
  if (before) do.call(par, options$pars)
}, rgl = hook_rgl, crop = hook_pdfcrop)
opts_knit$set(animation.fun = hook_scianimator)

invisible(local({
  f = commandArgs(TRUE)
  base = sub('\\.[Rr]md$', '', basename(f))
  # each source file corresponds to a separate fig.path and cache.path
  opts_chunk$set(cache.path = paste('cache', base, '', sep = '/'),
                 fig.path = paste(base, '', sep = '/'))
  # generate figures to the ./figure/ directory
  if (!file.exists('figure/')) dir.create('figure')
  opts_knit$set(base.dir = normalizePath('figure', mustWork = TRUE))
  # I save figures to my Dropbox folder
  opts_knit$set(base.url = if (Sys.getenv('USER') != 'yihui') '/figure/' else
    'http://dl.dropbox.com/u/15335397/vistat/')
  knit(f, paste('_posts/', base, '.md', sep = ''), envir = globalenv())
}))
